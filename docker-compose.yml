version: "3"

services:
    #zookeeper:
    #    image: zookeeper
    #    restart: always
    consul:
        image: consul
        command: consul agent -server -dev -client=0.0.0.0 -ui -bootstrap -log-level warn
        ports:
            - "8400:8400"
            - "8500:8500"
            - "8600:53/udp"

    traefik:
        restart: always
        image: traefik:alpine
        depends_on: 
            # - zookeeper
            - consul
        links:
            - modoki # --traefikAddr of modoki
        ports: 
            - 80:80
            - 443:443
        volumes:
            - "./traefik:/usr/local/traefik"
        command:
            - --configfile=/usr/local/traefik/traefik.toml
            - --web
            #- --zookeeper
            #- --zookeeper.endpoint=zookeeper:2181
            #- --zookeeper.prefix=traefik
            #- --zookeeper.watch=true
            - --consul
            - --consul.endpoint=consul:8500
            - --debug

    modoki:
        restart: always
        build: .
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./cred:/usr/local/modoki/cred
        depends_on:
            - mysql
            # - zookeeper
            - consul
        command:
            - --db=root:${DB_PASSWORD}@tcp(mysql:3306)/modoki?charset=utf8mb4&parseTime=True
            - --zookeeper=consul:2181
            - --docker-api=v1.37
            - --traefikAddr=http://modoki
            - --jwtkey=/usr/local/modoki/cred/jwt.example.key
            - --jwtpub=/usr/local/modoki/cred/jwt.example.key.pub
            

    mysql:
        restart: always
        volumes:
            - mysql-volume:/var/lib/mysql
        image: mysql
        user: mysql
        command: 
            - mysqld
            - --character-set-server=utf8mb4
            - --collation-server=utf8mb4_unicode_ci
        environment: 
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
            MYSQL_DATABASE: modoki

volumes:
    mysql-volume:
        driver: local
